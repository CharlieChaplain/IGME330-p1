<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Stars Test</title>
	<style type="text/css">
	canvas{
		border:1px solid gray;
	}
	*{
		font-family: tahoma, verdana, sans-serif;
	}
	</style>
	<script>
		// #0 - in this class we will always use ECMAScript 5's "strict" mode
		// See what 'use strict' does here:
		// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions_and_function_scope/Strict_mode
		'use strict';
		
		// #1 call the init function after the pages loads
		window.onload = init;
		var ctx;
        var canvas;
        var allStars = [];
        var currentSpeed;
        var allGuns = [];
        
        function Gun(x,y){
            this.x = x;
            this.y = y;
            this.rotation = 0;
            this.lasers = [];
        }
        
        function Bolt(x,y,rotation){
            this.x = x;
            this.y = y;
            this.rotation = rotation;
            this.speed = 20;
            this.length = 10;
            this.width = 4;
            
        }
        
        Gun.prototype.draw = function(ctx){
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            ctx.fillStyle = '#aaa';
            ctx.fillRect(40, -25, 60, 10);
            ctx.fillRect(40, 15, 60, 10);
            ctx.fillStyle = '#444';
            ctx.fillRect(-20, -40, 60, 80);
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.arc(0, 0, 30, 0, Math.PI*2, false);
            ctx.fill();
            ctx.stroke();
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(0, 0, 5, 0, Math.PI*2, false);
            ctx.stroke();
            ctx.restore();
        };
        
        Gun.prototype.update = function(){
            this.rotation += 0.02;
            
            for(var i = 0; i< this.lasers.length; i++){
                var bolt = this.lasers[i];
                bolt.x += bolt.speed;
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(bolt.rotation);
                ctx.fillStyle = "#0f0";
                ctx.fillRect(bolt.x, bolt.y, bolt.length, bolt.width);
                ctx.restore();    
            }
        };
        
        Gun.prototype.fire = function(ctx){
            //first num = the length of the barrel rect + the width of the main rect - the x offset of the main rect of the cannon
            //second num = y loc of top barrel + 1/2 width of barrel - 1/2 width of bolt
            var bolt = new Bolt(80, -13, this.rotation);
            this.lasers.push(bolt);
            
            if(this.lasers.length >= 10){
                this.lasers.shift();
            }
        };
        
		function init(){
			console.log("page loaded!");
			// #2 Now that the page has loaded, start drawing!
			
			// A - canvas variable points at <canvas> tag
			canvas = document.querySelector('canvas');
			
			// B - the ctx variable points at a "2D drawing context"
			ctx = canvas.getContext('2d');
            
            document.querySelector('#starSpeed').onchange = function(e){
                currentSpeed = e.target.value;
            }
			for(var i=1; i <= 4; i++) { allGuns.push(new Gun(i*100, i * 100)); }
            
            currentSpeed = 10;
            
            for(var i = 0; i < 100; i++){
                makeStar(currentSpeed);
            }
            
            console.dir(allStars);
            
            requestAnimationFrame(update);
		}
        
        function update(){
            requestAnimationFrame(update);
            
            ctx.fillStyle = 'black';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            
            for(var i = 0; i < allStars.length; i++){
                allStars[i].update();
                allStars[i].draw();
            }
            
            for(var i=0; i<allGuns.length; i++){
                allGuns[i].update();
                allGuns[i].draw(ctx);
                allGuns[i].fire(ctx);
            }
            
            respawnStar();
            
        }
		
        function makeStar(speed){
            var s = {};
            
            s.x = canvas.width + 10;
            s.y = getRandomInt(0, canvas.height);
            
            s.r = getRandomInt(0.5, 2);
            s.speed = getRandomInt(0.8 * speed, 5 * speed);
            s.update = function(){
                this.x -= this.speed;
            };
            s.draw = function(){
                ctx.save();
                ctx.fillStyle = "white";
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI*2, false);
                ctx.fill();
                ctx.restore();
            };
            
            Object.seal(s);
            allStars.push(s);
        }
        
        function respawnStar(){
            for(var i=0; i < allStars.length; i++){
                if(allStars[i].x < 0){
                    allStars.splice(i, 1);
                    makeStar(currentSpeed);
                }
            }
        }
        
		function drawQuadCurve(x1,y1,cpX,cpY,x2,y2,color,closePath,debug){
            ctx.save();
            ctx.strokeStyle = color;
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            
            ctx.quadraticCurveTo(cpX, cpY, x2, y2);
            
            if(closePath){ ctx.closePath(); }
            
            ctx.stroke();
            
            if(debug){
                ctx.fillStyle = 'black';
                ctx.fillRect(x1,y1,7,7);
                ctx.fillRect(x2,y2,7,7);
                ctx.fillStyle = 'red';
                ctx.fillRect(cpX,cpY,7,7);
            }
            ctx.restore();
		}
		
		function getRandomInt(min, max) {
  			return Math.floor(Math.random() * (max - min)) + min;
		}
		
		function getRandomColor(){
			function getByte(){
				return 55 + Math.round(Math.random() * 200);
			}
			return "rgba(" + getByte() + "," + getByte() + "," + getByte() + ",.8)";
		}
	</script>
</head>
<body>
	<canvas width="1080" height="760">
		Get a real browser!
	</canvas>
	
    <input type="range" min="1" max="10" value="5" class="slider" id="starSpeed"><label for="starSpeed">Star Speed</label>
    
</body>
</html>