
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Amorphious++</title>
	<style>
        body {
            background: #000;
            font-family: tahoma, verdana, sans serif;
            margin: 0;
            color: #aab;
        }
        this.canvas {
            margin: auto;
            margin-top: 20px;
            margin-bottom: 20px;
            background: black;
            display: block;
            color: #556;
            border-color: #556;
            border-width: 15px;
            border-style: solid;
            box-shadow: 5px 5px 8px #112 inset;
            border-radius: 20px;
        }        
        h1{
            font-family: recharge;
            font-size: 50pt;
            text-shadow: 2px 2px 1px #112, -2px -2px 1px #eef;
            
        } 
        hr{
            clear:both;
        }
        footer{
            padding: 20px;
            margin: 20px;
            color: #556;
            background: #bbc;
            text-align: center;
            font-family: nasalization;
            border-color: #556;
            border-width: 15px;
            border-style: solid;
            font-size: 20pt;
            clear: both;
            box-shadow: 5px 5px 8px #112 inset;
            border-radius: 20px;
            text-shadow: 1px 1px 1px #112, -1px -1px 1px #eef;
        }
     
      
        
	</style>
	<script>
    // PROGRAMMED BY Joel Petritsch AND Stephen Callen
        "use strict";
        
        var app = app || {};

		app.main = {
            animation: undefined, //required: loaded by this script
            canvas: undefined,
            ctx: undefined,     
            timeLeft: 0,
            lastTime: 0, //used by calculateDeltaTime
            dt: 0,
            angle: 0,
            swordAngle: undefined,
            animationID: 0,
            player: {
                x:100,
                y:100,
                img: undefined,
                animations: [],            
                currentAnimation: undefined,
                score:0,
                tempScore:0,
                comboMulti:0,
                state: 0,
                OOFtimer: 0
            },
            GAME_STATES: Object.freeze({
                TITLE: 0,
                GAME: 1,
                PAUSE: 2,
                GAMEOVER: 3
            }),
            gameState: undefined,
            toRemoveArray: [],
            enemies: [],
            mouse: {
                x:undefined,
                y:undefined
            },
            movementVector: {
                x:undefined,
                y:undefined
            },
            
            doMouseMove: function(e){        
                this.mouse.x = e.pageX - e.target.offsetLeft;
                this.mouse.y = e.pageY - e.target.offsetTop;
            },
            doMouseDown: function(e){ 
                if(this.gameState == this.GAME_STATES.TITLE){
                    this.gameState = this.GAME_STATES.GAME;
                }
                else if(this.gameState == this.GAME_STATES.GAME){
                    if(this.timeLeft==0){
                    this.timeLeft = 1;
                }
                }
                else if(this.gameState == this.GAME_STATES.GAMEOVER){
                    this.gameState = this.GAME_STATES.TITLE;
                }
                
                
            },
            init: function(){
                // set up canvas stuff
                this.canvas = document.querySelector('canvas');
                this.ctx = this.canvas.getContext("2d");
                
                //sets up animation stuff
                this.Animation.prototype.updateAnimation = function(dt){
                    this.animTimer += dt;
                    if(this.animTimer >= this.spf){
                        this.animTimer = 0;
                        if(this.currentFrame >= this.numFrames - 1){
                            this.currentFrame = 0;
                        }
                        else{
                            this.currentFrame++;
                        }
                    }
                }

                this.Animation.prototype.drawAnimation = function(ctx, x, y){
                    ctx.drawImage(this.image, this.width * this.currentFrame, 0, this.width, this.height, x, y, this.width, this.height);
                }
                
                this.player.img = document.getElementById("player");
                var walkAnim = new this.Animation(this.player.img, 4, 0.25, 46, 46);
                this.player.animations.push(walkAnim);
                this.player.currentAnimation = this.player.animations[0];
                
                this.gameState = this.GAME_STATES.TITLE;
                
                this.canvas.onmousemove = this.doMouseMove.bind(this);
                this.canvas.onmousedown = this.doMouseDown.bind(this);
                
                // start animation loop
                this.update();
                


            },
            update: function() { 
                // this schedules a call to the update() method in 1/60 seconds
                this.dt = calculateDeltaTime();

                this.ctx.fillRect(0,0,1024,768);
                
                if(this.gameState == this.GAME_STATES.TITLE){
                    this.ctx.save();
                    this.ctx.font = "30px Verdana";
                    this.ctx.fillStyle = "white";
                    this.ctx.textAlign = "center";
                    this.ctx.textBaseline = "middle";
                    this.ctx.fillText("CLICK TO START", this.canvas.width / 2, this.canvas.height / 2);
                    this.ctx.restore();
                    //resets the game
                    this.player.state = 0;
                    this.enemies = [];
                }
                if(this.gameState == this.GAME_STATES.GAME){
                    this.movePlayer();
                    this.updateEnemies();
                     
                }
                if(this.gameState == this.GAME_STATES.GAMEOVER){
                    this.ctx.save();
                    this.ctx.font = "30px Verdana";
                    this.ctx.fillStyle = "white";
                    this.ctx.textAlign = "center";
                    this.ctx.textBaseline = "middle";
                    this.ctx.fillText("GAME OVER", this.canvas.width / 2, this.canvas.height / 2);
                    this.ctx.fillText("click to retry", this.canvas.width / 2, this.canvas.height / 2 + 30);
                    this.ctx.restore();
                }
                //THIS IS THE UPDATE METHOD. IMPORTANT
                this.animationID = requestAnimationFrame(this.update.bind(this));
                
                this.ctx.save();
                this.ctx.fillStyle = "white";
                this.ctx.font = "24px Verdana";
                this.ctx.fillText(this.player.score, 850, 750,);

                this.ctx.restore();
            },
            movePlayer: function(){     
                //console.log(this.player.state);
                if(this.timeLeft ==0 && this.player.state == 0){//if we can move, move

                    this.movementVector.x = this.mouse.x - this.player.x;
                    this.movementVector.y = this.mouse.y - this.player.y;
                    var magnitude = (this.movementVector.x * this.movementVector.x) + (this.movementVector.y * this.movementVector.y);
                    magnitude = Math.sqrt(magnitude);//always move a specific speed

                    this.angle = Math.atan2(this.movementVector.y, this.movementVector.x)


                    if(Math.abs(this.movementVector.x)> 26){// if we are more than like, 3 pixels away
                        this.player.x = this.player.x + this.dt*this.movementVector.x*300/magnitude;//actually move this.player
                    }
                    if(Math.abs(this.movementVector.y)> 26){// if we are more than like, 3 pixels away
                        this.player.y = this.player.y +  this.dt*this.movementVector.y*300/magnitude;//Move this.player normalized distance
                    }                
                }
                else if(this.player.state == 1){//OOF
                    this.player.OOFtimer -= this.dt;
                    if (this.player.OOFtimer <= 0){
                        this.player.state = 0;
                    }

                }
                else if(this.player.state !=0){//DED
                    this.gameState = this.GAME_STATES.GAMEOVER;
                }
                else{//otherwise, just swing the weapon.
                this.timeLeft-= this.dt;
                    if(this.timeLeft < 0){
                        this.timeLeft = 0;
                    }
                }


                this.ctx.save();
                this.ctx.translate(this.player.x, this.player.y);
                this.ctx.rotate(this.angle);
                this.ctx.translate(-13, -26); 
                this.player.currentAnimation.updateAnimation();
                this.player.currentAnimation.drawAnimation(this.ctx, 0, 0);  
                this.ctx.translate(13, 26);
                if(this.timeLeft>0){       
                    this.swordAngle = this.angle + ((-1+this.timeLeft) * Math.PI) ;
                    if(this.swordAngle< 0){
                            this.swordAngle+= Math.PI*2//0 is straight down
                        }
                    this.swordAngle -= Math.PI/2;//update sword for collisions
                    if(this.swordAngle< 0){
                            this.swordAngle+= Math.PI*2//0 is straight down
                        }

                    this.ctx.rotate(((-1+this.timeLeft) * Math.PI));               
                }
                this.ctx.beginPath();            
                this.ctx.strokeStyle = "red";
                this.ctx.moveTo(0,0);
                this.ctx.lineTo(0,100);
                this.ctx.stroke();
                this.ctx.restore();

            },
            updateEnemies: function(){

                var maxEnemies =Math.min( Math.max(Math.sqrt(this.player.score), 3), 7);            
                while(this.enemies.length < maxEnemies){
                    var temp ={
                        x : Math.random() * 1024,
                        y : Math.random() * 768,
                        DeltaX : (Math.random()-.5) * 600,
                        DeltaY : (Math.random()-.5) * 600, 
                        img : document.getElementById("Blob"),
                        type : 0,
                        radius: 16

                    }
                    var Determinator = Math.random()*4;
                    Determinator = Math.trunc(Determinator);// Determine Spawn Location
                    switch(Determinator){
                        case 1:
                            temp.x =0;
                            if(temp.DeltaX < 0){
                                temp.DeltaX *=-1;
                            }
                            break;
                        case 2:
                            temp.x=1024;
                            if(temp.DeltaX > 0){
                                temp.DeltaX *=-1;
                            }
                            temp.img = document.getElementById("BluBlob")
                            break;
                        case 3:
                            temp.y=0;
                             if(temp.DeltaY < 0){
                                temp.DeltaY*=-1;
                            }
                             temp.img = document.getElementById("RedBlob")
                            break;
                        default:
                            if(temp.DeltaY > 0){
                                temp.DeltaY*=-1;
                            }
                            temp.y = 768;
                            break;
                    }

                    Determinator = Math.random()*3;//Determine enemy Type
                    Determinator = Math.trunc(Determinator);
                    switch(Determinator){ //Switch between sprites                 
                        case 1:                       
                            temp.img = document.getElementById("BluBlob")
                            temp.type = 1;
                            break;
                        case 2:
                            temp.img = document.getElementById("RedBlob")
                            temp.type = 2;
                            break;
                        default:
                            temp.type = 0;
                            break;
                    }

                    this.enemies.push(temp);
                }


                for(var i =0; i < maxEnemies; i++){
                    if(this.enemies[i].x < 0 || this.enemies[i].x > 1024 || this.enemies[i].y < 0 || this.enemies[i].y > 768){//if we go off screen, delete this next frame
                       this.toRemoveArray.unshift(i);
                    }
                    else{//if we are still on screen
                        var enemyAngle = {x:0,y:0,magnitude:0,angle:0};
                        enemyAngle.x= this.player.x - this.enemies[i].x;
                        enemyAngle.y = this.player.y - this.enemies[i].y;
                        enemyAngle.magnitude = Math.sqrt((enemyAngle.x* enemyAngle.x) + (enemyAngle.y * enemyAngle.y));
                        enemyAngle.angle = Math.atan2(enemyAngle.y, enemyAngle.x);
                        if(enemyAngle.angle < 0){//edit angle for matchmaking
                            enemyAngle.angle += Math.PI*2                    
                        }


                         switch(this.enemies[i].type){
                               case 1:                          

                                    var myAngle=0, deltaAngle=0;                                
                                    deltaAngle = (enemyAngle.angle - myAngle);  

                                    enemyAngle.angle = myAngle + deltaAngle;                                 
                                    this.enemies[i].DeltaX = Math.cos(enemyAngle.angle)*150;
                                    this.enemies[i].DeltaY = Math.sin(enemyAngle.angle)*150;

                                    if(enemyAngle.angle < 0){//edit angle for matchmaking
                                        enemyAngle.angle += Math.PI*2                    
                                    }
                                    break;
                               case 2:

                                   break;
                               default:

                                   break;
                           }
                        if(enemyAngle.magnitude < 20){
                            if(this.enemies[i].type == 0){
                                this.player.state= 1;
                                this.player.OOFtimer = .5;
                            }
                            else{
                                this.player.state=2;//DED
                            }
                        }




                        if( this.timeLeft > 0){//if we are swinging
                            var anglediff = Math.abs(enemyAngle.angle - this.swordAngle) * 180/Math.PI;
                            if(( anglediff < 10) && (enemyAngle.magnitude < 120)){//collision check
                                this.toRemoveArray.unshift(i);
                                this.player.tempScore+=this.enemies[i].type;
                                this.player.comboMulti+=1;
                            }
                        }
                        else if (this.player.tempScore> 0){//when our swing is done
                            this.player.score += (this.player.tempScore* this.player.comboMulti);
                            //console.log(this.player.tempScore + " * " + this.player.comboMulti);   
                            this.player.tempScore= 0;
                            //console.log(this.player.score);
                            this.player.comboMulti =0;

                        }
                        this.enemies[i].x += this.enemies[i].DeltaX*this.dt;
                        this.enemies[i].y += this.enemies[i].DeltaY*this.dt;
                    }
                    this.ctx.save();
                    this.ctx.translate(-19,-17)
                    this.ctx.drawImage(this.enemies[i].img, this.enemies[i].x, this.enemies[i].y)
                    this.ctx.restore();
                }               
                while(this.toRemoveArray.length > 0){
                    this.enemies.splice(this.toRemoveArray[0], 1);
                    this.toRemoveArray.splice(0,1);
                }


            },
            
            Animation: function(image, numFrames, secondsPerFrame, frameWidth, frameHeight){
                this.image = image;
                this.numFrames = numFrames;
                this.spf = secondsPerFrame;
                this.width = frameWidth;
                this.height = frameHeight;
                this.currentFrame = 0;
                this.animTimer = 0;
            }
            
        }
		
		window.onload = function(){
            console.log("window.onload called");
            //app.main.animation = app.animation;
            app.main.init();
        }
	</script>
</head>
<body>
    <img src="CharacterV2.png" id="player">
    <img src="AngeryBoi.png" id="Blob">
    <img src="RedBoi.png" id="RedBlob">
    <img src="BluBoi.png" id="BluBlob">
    <canvas id="canvas" width="1024" height="768"><canvas>  
	<script src='animation.js'></script>
    <script src='utilities.js'></script>
    
    <footer>
        <p>Joel Petritsch, Stephen Callen | 2018</p>        
    </footer>
</body>
    
</html>
